<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>n8n Chat Demo</title>
    <style>
        :root {
            --gap: 1rem;
            --radius: .75rem;
            --primary: #2563eb;
            --bg: #f8fafc;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: system-ui, sans-serif;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--gap);
            height: 100vh;
        }
        h1 { margin: .25rem 0 1rem; font-size: 1.4rem; }
        #chatbox {
            flex: 1 1 auto;
            width: 100%;
            max-width: 600px;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: var(--radius);
            padding: var(--gap);
            overflow-y: auto;
        }
        .msg { margin-bottom: .6rem; line-height: 1.45; }
        .msg strong { color: var(--primary); }
        form {
            display: flex;
            gap: .5rem;
            width: 100%;
            max-width: 600px;
            margin-top: var(--gap);
        }
        input[type="text"] {
            flex: 1;
            padding: .65rem .9rem;
            font-size: 1rem;
            border: 1px solid #d1d5db;
            border-radius: var(--radius);
        }
        button {
            padding: .65rem 1rem;
            font-size: 1rem;
            border: none;
            border-radius: var(--radius);
            background: var(--primary);
            color: #fff;
            cursor: pointer;
            flex-shrink: 0;
        }
        button:disabled { opacity: .4; cursor: not-allowed; }
        #preview-area {
            width: 100%;
            max-width: 600px;
            padding: 0 .5rem .5rem;
            display: flex;
            align-items: center;
        }
        #preview-area img {
            max-height: 80px;
            border-radius: var(--radius);
        }
        #preview-area button {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #9ca3af;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>n8n ì±—ë´‡</h1>

    <div id="chatbox" aria-live="polite" aria-label="ëŒ€í™” ë‚´ìš©"></div>

    <div id="preview-area"></div>

    <form id="chat-form" autocomplete="off">
        <button type="button" id="addFileBtn">+</button>
        <input id="userInput" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”â€¦" />
        <button type="button" id="sttBtn">ğŸ¤</button> 
        <button type="submit">ì „ì†¡</button>
        
        <input type="file" id="fileInput" accept="image/*" style="display: none;" />
    </form>
    
    <script src="https://cdn.jsdelivr.net/npm/microsoft-cognitiveservices-speech-sdk/distrib/browser/microsoft.cognitiveservices.speech.sdk.bundle.js"></script>

    <script>
        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         * Utility helpers and DOM Elements
         * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        const qs = (sel, scope = document) => scope.querySelector(sel);
        const on = (el, type, cb) => el.addEventListener(type, cb);
        const escapeHTML = str => str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));

        const chatbox     = qs('#chatbox');
        const userInput   = qs('#userInput');
        const form        = qs('#chat-form');
        const sendBtn     = qs('button[type="submit"]', form);
        const sttBtn      = qs('#sttBtn');
        const addFileBtn  = qs('#addFileBtn');
        const fileInput   = qs('#fileInput');
        const previewArea = qs('#preview-area');

        let fileToSend = null; // ì „ì†¡í•  íŒŒì¼ì„ ì„ì‹œ ì €ì¥
        let recognizer; // ìŒì„± ì¸ì‹ê¸°

        // ì„¸ì…˜ ID ì„¤ì •
        let sessionId = sessionStorage.getItem('chatSessionId');
        if (!sessionId) {
            sessionId = `web-user-${Date.now()}`;
            sessionStorage.setItem('chatSessionId', sessionId);
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         * Core Functions
         * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        
        // ë©”ì‹œì§€/ì´ë¯¸ì§€ UI ì¶”ê°€ í•¨ìˆ˜ (ì¤‘ë³µ ì œê±°)
        const addLine = (who, content, isHtml = false) => {
            const p = document.createElement('p');
            p.className = 'msg';
            p.innerHTML = `<strong>${who}:</strong> ${isHtml ? content : escapeHTML(content)}`;
            chatbox.appendChild(p);
            chatbox.scrollTop = chatbox.scrollHeight;
        };

        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° UI í‘œì‹œ í•¨ìˆ˜
        const showPreview = (file) => {
            fileToSend = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                previewArea.innerHTML = `
                    <img src="${e.target.result}" alt="ë¯¸ë¦¬ë³´ê¸°">
                    <button type="button" id="remove-preview-btn">Ã—</button>
                `;
                userInput.disabled = true;
            };
            reader.readAsDataURL(file);
        };

        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° UI ì œê±° í•¨ìˆ˜
        const clearPreview = () => {
            fileToSend = null;
            previewArea.innerHTML = '';
            userInput.disabled = false;
            userInput.focus();
        };

        // 'ì „ì†¡' ë²„íŠ¼ì˜ ë©”ì¸ ë¡œì§
        const handleSend = async (ev) => {
            ev?.preventDefault();

            // 1. ë³´ë‚¼ íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
            if (fileToSend) {
                const file = fileToSend;
                const filePreviewUrl = URL.createObjectURL(file); // ë¯¸ë¦¬ë³´ê¸°ìš© URL ìƒì„±
                clearPreview();

                addLine('ë‚˜', `<img src="${filePreviewUrl}" alt="ì „ì†¡ ì´ë¯¸ì§€" width="200">`, true);
                sendBtn.disabled = true;

                try {
                    const formData = new FormData();
                    formData.append('image_file', file);
                    const res = await fetch('/upload-image', { method: 'POST', body: formData });
                    if (!res.ok) throw new Error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨');
                    
                    const result = await res.json();
                    const imageUrl = result.image_url;

                    // n8nì— ì´ë¯¸ì§€ URL ì •ë³´ ì „ì†¡
                    const n8nRes = await fetch('/send-message', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ messages: `ì´ë¯¸ì§€ ì „ì†¡ë¨: ${imageUrl}`, sessionId })
                    });
                    if (!n8nRes.ok) throw new Error('n8n ì„œë²„ í†µì‹  ì‹¤íŒ¨');
                    
                    const { text } = await n8nRes.json();
                    addLine('ì±—ë´‡', text);

                } catch (err) {
                    console.error(err);
                    addLine('ì‹œìŠ¤í…œ', `âš ï¸ ${err.message}`);
                } finally {
                    sendBtn.disabled = false;
                }
            
            // 2. ë³´ë‚¼ íŒŒì¼ì´ ì—†ìœ¼ë©´ í…ìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡
            } else {
                const msg = userInput.value.trim();
                if (!msg) return;

                addLine('ë‚˜', msg);
                userInput.value = '';
                userInput.focus();
                sendBtn.disabled = true;

                try {
                    const res = await fetch('/send-message', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ messages: msg, sessionId })
                    });
                    if (!res.ok) throw new Error(`ì„œë²„ ì˜¤ë¥˜ ${res.status}`);
                    
                    const { text } = await res.json();
                    addLine('ì±—ë´‡', text);
                } catch (err) {
                    console.error(err);
                    addLine('ì‹œìŠ¤í…œ', `âš ï¸ ${err.message}`);
                } finally {
                    sendBtn.disabled = false;
                }
            }
        };

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         * Event Listeners
         * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        
        // 'ì „ì†¡' ë²„íŠ¼ í´ë¦­ ë˜ëŠ” Enter í‚¤
        on(form, 'submit', handleSend);
        on(userInput, 'keydown', e => { if (e.key === 'Enter' && !e.shiftKey) handleSend(e); });
        
        // '+' ë²„íŠ¼ í´ë¦­
        on(addFileBtn, 'click', () => fileInput.click());

        // íŒŒì¼ ì„ íƒ
        on(fileInput, 'change', e => {
            const file = e.target.files[0];
            if (file) showPreview(file);
            fileInput.value = '';
        });

        // ë¶™ì—¬ë„£ê¸°
        on(userInput, 'paste', e => {
            const file = e.clipboardData.files[0];
            if (file && file.type.startsWith('image/')) {
                e.preventDefault();
                showPreview(file);
            }
        });

        // ë¯¸ë¦¬ë³´ê¸° ì œê±° ë²„íŠ¼ í´ë¦­ (ì´ë²¤íŠ¸ ìœ„ì„)
        on(previewArea, 'click', e => {
            if (e.target.id === 'remove-preview-btn') {
                clearPreview();
            }
        });
        
        // ìŒì„± ì¸ì‹(STT) ê´€ë ¨
        on(document, 'DOMContentLoaded', async () => {
            sttBtn.disabled = true;
            try {
                const response = await fetch('/api/get-speech-token');
                if (!response.ok) throw new Error('ì¸ì¦ í† í°ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                const data = await response.json();
                const speechConfig = SpeechSDK.SpeechConfig.fromAuthorizationToken(data.token, data.region);
                speechConfig.speechRecognitionLanguage = 'ko-KR';
                const audioConfig = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
                recognizer = new SpeechSDK.SpeechRecognizer(speechConfig, audioConfig);
                sttBtn.disabled = false;
                console.log("ìŒì„± ì¸ì‹ê¸° ì´ˆê¸°í™” ì™„ë£Œ");
            } catch (error) {
                console.error("ìŒì„± ì¸ì‹ê¸° ì´ˆê¸°í™” ì‹¤íŒ¨:", error);
                sttBtn.innerHTML = 'âš ï¸';
            }
        });

        on(sttBtn, 'click', () => {
            if (!recognizer) return;
            
            sttBtn.disabled = true;
            sttBtn.innerHTML = 'ğŸ‘‚';
            userInput.value = '';
            userInput.placeholder = 'ë§ì”€í•˜ì„¸ìš”...';

            recognizer.recognizeOnceAsync(result => {
                if (result.reason === SpeechSDK.ResultReason.RecognizedSpeech) {
                    userInput.value = result.text;
                } else {
                    userInput.placeholder = 'ìŒì„± ì¸ì‹ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.';
                }
                sttBtn.disabled = false;
                sttBtn.innerHTML = 'ğŸ¤';
            });
        });

    </script>
</body>
</html>